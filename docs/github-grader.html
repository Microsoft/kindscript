<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://www.facebook.com/2008/fbml">

<head>
    <meta charset="UTF-8">
    <title>MakeCode Grader</title>
    <link rel="stylesheet"
        href="https://pxt.azureedge.net/blob/2163189fd5e35c0981ed55318415582a7c9aeb12/doccdn/semantic.css"
        type="text/css">
    <style>
        @targetstyle@ 
        #user {
            width: 14rem;
        }

        #repoes {
            overflow-y: auto;
        }

        #repocolumn {
            padding: 0.5rem;
            position: absolute;
            width: 18rem;
            height: calc(100% - 6rem);
            border: none;
            left: 0;
            right: calc(100% - 18rem);
            bottom: 3rem;
            top: 3rem;
            overflow-x: hidden;
            overflow-y: auto;
        }

        #makecodecolumn {
            position: absolute;
            width: calc(100% - 18rem);
            height: calc(100% - 6rem);
            border: none;
            left: 18rem;
            right: 0;
            bottom: 3rem;
            top: 3rem;
        }

        .footer {
            position: absolute !important;
            bottom: 0 !important;
        }
    </style>
    <script type="text/javascript"
        src="https://pxt.azureedge.net/blob/4d9b3a258759c53e7bc66b6fc554c51e2434437c/doccdn/jquery.js"></script>
    <script type="text/javascript"
        src="https://pxt.azureedge.net/blob/fc2f56f46189a2e8be3743a1a5abed3b676f9318/doccdn/semantic.js"></script>
    <script>
        const api = "https://api.github.com";

        const targets = {
            "ev3": {
                name: "LEGO Mindstorms EV3",
                url: "https://makecode.mindstorms.com/beta"
            },
            "arcade": {
                name: "Arcade",
                url: "https://arcade.makecode.com/beta"
            },
            "microbit": {
                name: "micro:bit",
                url: "https://makecode.microbit.org/beta"
            },
            "maker": {
                name: "Maker",
                url: "https://maker.makecode.com"
            }
        }

        async function sniffTarget(repo) {
            const response = await fetch(`https://raw.githubusercontent.com/${repo.full_name}/master/README.md?token=${token()}`);
            const msg = await response.text();
            return Object.keys(targets)
                .find(k => msg.indexOf(`PXT/${k}`) > -1)
        }

        async function fetchUserRepos(user) {
            const query = `user:${user} in:name,description,readme "for PXT/"`;
            const url = `${api}/search/repositories?q=${encodeURIComponent(query)}&sort=updated&access_token=${token()}&anti_cache=${Math.random()}`;
            const response = await fetch(url);
            const { items } = await response.json();
            for (let i = 0; i < items.length; ++i) {
                const target = await sniffTarget(items[i]);
                if (!target)
                    items[i] = undefined;
                else
                    items[i].target = target;
            }
            return items.filter(m => !!m);
        }

        async function fetchUser(user) {
            const response = await fetch(`${api}/users/${user}?access_token=${token()}`);
            const msg = await response.json();
            return msg;
        }

        async function update() {
            $('#userparent').addClass('loading');
            try {
                $("#repoes")
                    .empty();
                const userName = $("#user").val();
                const user = await fetchUser(userName);
                $('#repoes')
                    .append(`<a href="https://github.com/${user.login}" class="ui link item" title="Open user profile">
                    <div class="ui mini image">
      <img src="${user.avatar_url}">
    </div>
    <div class="content">
        <div class="header">${user.name}</div>
        <div class="description">${user.login}</div>
    </div>
</a>`)
                const repoes = await fetchUserRepos(userName);
                $("#repoes")
                    .append(
                        repoes.map(repo =>
                            $(
                                `<div class="ui link item">
                                    <div class="ui mini image">
      <img src="${targets[repo.target].url.replace(/\/\w+$/, '')}/favicon.ico">
    </div>
    <div class="content">
        <div class="header">${repo.name.replace(/^pxt-/, '')}</div>
        <div class="description">${targets[repo.target].name}</div>
    </div>
</div>`).click(() => {
                                    if (typeof mscc !== "undefined" && !mscc.hasConsent())
                                        mscc.setConsent();
                                    pxt.aiTrackEvent("grader.openrepo")
                                    const url = targets[repo.target].url +
                                        "?controller=1&editorlayout=ide&ws=mem" +
                                        "#pub:" +
                                        "https://github.com/" +
                                        repo.full_name
                                    console.log(url);
                                    $("#makecodecolumn").attr("src", url);
                                })
                        )
                    );
            } finally {
                $('#userparent').removeClass('loading');
            }
        }

        function token() {
            return localStorage["core/githubtoken"];
        }

        function checkToken() {
            // sniff oauth
            let keys = {};
            window.location.hash.replace(/^#/, '').split('&')
                .map(v => v.split('=', 2))
                .forEach(a => keys[a[0]] = a[1]);

            if (keys["access_token"]) {
                if (keys["state"] == localStorage["core/oauthState"]) {
                    localStorage["core/githubtoken"] = keys["access_token"];
                }
                delete localStorage["core/oauthState"];
                window.location.hash = "";
            }

            // force sign...
            if (token()) return;

            console.log(`redirecting to oauth page`)
            const state = Math.random().toString();
            localStorage["core/oauthState"] = state;
            const login = "https://makecode.com/oauth/login?state=" + state +
                "&response_type=token&client_id=gh-token&redirect_uri=" +
                encodeURIComponent(window.location.href.split('#', 1)[0])
            window.location.href = login;
        }

        $(function () {
            console.log(`loaded...`);
            checkToken();
            $("#generate").click(update);
            $("#user").on("keydown", function search(e) {
                if (e.keyCode == 13) {
                    update();
                }
            });

        });

        console.log("starting...");
    </script>
</head>

<body id='root' class='root'>
    <nav class="ui menu inverted fixed borderless">
        <div class="menu left">
            <div class="ui item">
                MakeCode GitHub Grader
            </div>
        </div>
    </nav>
    <div id="repocolumn">
        <div id="userparent" class="ui left icon input">
            <input id="user" class="ui fluid" type="text" placeholder="Enter GitHub user" />
            <i class="search icon"></i>
        </div>
        <div id="repoes" class="ui selection list"></div>
    </div>
    <iframe id="makecodecolumn"></iframe>
    </div>
    <script type="text/javascript"
        src="https://pxt.azureedge.net/blob/795d8506c80a04f5ca26f577a8d6152e2fa3e7a6/doccdn/pxtweb.js"></script>
    <!-- @include apptracking.html -->
    <!-- @include thin-footer.html -->
</body>


</html>